@startuml Secuencia_07_Exportar_Excel

title Secuencia: Exportar Encuestas a Excel

actor "Administrador" as Admin
participant "Vista Web" as Vista
participant "ConfigClienteSatisfaccionController" as Controller
participant "RespuestaBL" as RespuestaBL
participant "RespuestaDAL" as RespuestaDAL
database "BD" as DB

== Solicitud de Exportación ==
Admin -> Vista: Acceder a reportes
Vista --> Admin: Mostrar dashboard con datos
Admin -> Vista: Clic en "Exportar a Excel"
Vista --> Admin: Confirmar rango de fechas y sala

Vista -> Controller: ExportarEncuestasExcel(salaId, fechaInicio, fechaFin)

== Obtener Preguntas para Encabezados ==
Controller -> RespuestaBL: ObtenerPreguntasIndicadores()
RespuestaBL -> RespuestaDAL: ObtenerPreguntasIndicadores()
RespuestaDAL -> DB: SELECT preguntas activas ordenadas
note right of DB
    SELECT IdPregunta, Texto AS Pregunta,
           Indicador, Orden, Multi
    FROM Pregunta
    WHERE Indicador IS NULL 
       OR Indicador <> 'NPS'
    ORDER BY Orden
end note
DB --> RespuestaDAL: Lista de preguntas
RespuestaDAL --> RespuestaBL: List<PreguntaIndicadorDTO>

== Obtener Respuestas Completas ==
Controller -> RespuestaBL: ObtenerRespuestasEncuestas(fechaInicio, fechaFin, salaId)
RespuestaBL -> RespuestaDAL: ObtenerRespuestasEncuestas(fechaInicio, fechaFin, salaId)
RespuestaDAL -> DB: SELECT todas las respuestas con JOIN
note right of DB
    SELECT
        re.IdRespuestaEncuesta,
        re.NroDocumento, re.Nombre,
        re.Celular, re.Correo,
        re.FechaRespuesta,
        re.IdTablet, t.Nombre AS NombreTablet,
        p.IdPregunta, p.Texto AS Pregunta,
        p.Indicador, p.Multi,
        o.Texto AS TextoOpcion,
        o.Valor AS ValorOpcion,
        o.TieneComentario,
        rp.Comentario
    FROM RespuestaEncuesta re
    LEFT JOIN RespuestaPregunta rp ON re.IdRespuestaEncuesta = rp.IdRespuestaEncuesta
    LEFT JOIN Pregunta p ON rp.IdPregunta = p.IdPregunta
    LEFT JOIN Opcion o ON rp.IdOpcion = o.IdOpcion
    LEFT JOIN Tablet t ON re.IdTablet = t.IdTablet
    WHERE re.IdSala = @salaId
      AND CONVERT(date, re.FechaRespuesta) BETWEEN @fechaInicio AND @fechaFin
    ORDER BY re.IdRespuestaEncuesta, p.Orden
end note
DB --> RespuestaDAL: Resultados planos (una fila por respuesta)
RespuestaDAL --> RespuestaBL: List<RespuestaPlanoDTO>

== Validación de Datos ==
Controller -> Controller: Verificar si hay datos
alt No hay encuestas
    Controller --> Vista: { success: false, mensaje: "Sin datos" }
    Vista --> Admin: Mostrar alerta
else Hay datos para exportar
    
    == Construcción del Excel ==
    Controller -> Controller: Inicializar EPPlus (ExcelPackage)
    note right of Controller
        Usa librería EPPlus
        LicenseContext = NonCommercial
    end note
    
    Controller -> Controller: Crear hoja "Encuestas"
    Controller -> Controller: Agregar título principal
    note right of Controller
        Fila 1: Título principal con merge
        "Reporte de Encuestas"
        Color de fondo azul oscuro
        Texto blanco en negrita
    end note
    
    Controller -> Controller: Agregar información de filtros
    note right of Controller
        Fila 2: "Sala ID: X | Rango: DD/MM/YYYY al DD/MM/YYYY"
        Texto en cursiva
    end note
    
    == Crear Encabezados ==
    Controller -> Controller: Agregar encabezados fijos
    note right of Controller
        Columnas fijas:
        - Nro Documento
        - Nombres
        - Teléfono
        - Correo
        - Id Tablet
        - Nombre Tablet
        - Valor NPS
        - Clasificación NPS
    end note
    
    Controller -> Controller: Agregar encabezados dinámicos
    loop Para cada pregunta
        Controller -> Controller: Agregar columna con texto de pregunta
    end
    
    Controller -> Controller: Aplicar estilos a encabezados
    note right of Controller
        Estilo de encabezados:
        - Fondo azul corporativo
        - Texto blanco en negrita
        - Alineación centrada
        - Bordes inferiores
    end note
    
    == Llenar Datos ==
    Controller -> Controller: Agrupar respuestas por IdRespuestaEncuesta
    
    loop Para cada encuesta
        Controller -> Controller: Extraer datos de cliente
        Controller -> Controller: Buscar valor NPS
        Controller -> Controller: Clasificar cliente según NPS
        note right of Controller
            Clasificación NPS:
            - Valor >= 4: Promotor
            - Valor = 3: Pasivo
            - Valor 1-2: Detractor
        end note
        
        Controller -> Controller: Agregar columnas fijas
        
        loop Para cada pregunta
            Controller -> Controller: Buscar respuestas de la pregunta
            alt Pregunta Multi (checkbox)
                Controller -> Controller: Concatenar múltiples respuestas
                note right of Controller
                    "Opción 1, Opción 2 (comentario)"
                end note
            else Pregunta single
                Controller -> Controller: Agregar una respuesta
            end
            
            alt Tiene comentario
                Controller -> Controller: Incluir comentario entre paréntesis
            end
        end
        
        Controller -> Controller: Agregar fila al Excel
    end
    
    == Formato y Ajustes ==
    Controller -> Controller: Auto-ajustar columnas
    Controller -> Controller: Congelar primera fila (encabezados)
    
    == Generar Archivo ==
    Controller -> Controller: Guardar Excel en MemoryStream
    Controller -> Controller: Convertir a Base64
    Controller -> Controller: Generar nombre de archivo
    note right of Controller
        Formato del nombre:
        "Encuestas_SalaX_DD_MM_YYYY_al_DD_MM_YYYY.xlsx"
    end note
    
    Controller --> Vista: { success: true, bytes: base64, excelName, mensaje }
end

== Descarga en Navegador ==
Vista -> Vista: Decodificar Base64 a Blob
Vista -> Vista: Crear enlace temporal de descarga
Vista -> Vista: Simular clic en enlace
Vista --> Admin: Iniciar descarga del archivo

Admin -> Admin: Abrir archivo Excel
note right of Admin
    El archivo incluye:
    - Todas las respuestas del periodo
    - Datos del cliente
    - Respuestas a todas las preguntas
    - Comentarios incluidos
    - Clasificación NPS
    - Formato profesional
end note

@enduml
