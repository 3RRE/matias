@startuml Secuencia_06_Configurar_Tablets

title Secuencia: Configurar Tablets por Sala

actor "Administrador" as Admin
participant "Vista Web" as Vista
participant "ConfigClienteSatisfaccionController" as Controller
participant "TabletBL" as TabletBL
participant "TabletDAL" as TabletDAL
database "BD" as DB

== Acceso a Configuración de Tablets ==
Admin -> Vista: Acceder a "Configuración de Tablets"
Vista --> Admin: Mostrar selector de salas
Admin -> Vista: Seleccionar sala

Vista -> Controller: ObtenerTabletsSala(salaId)
Controller -> TabletBL: ListadoTablets(salaId)
TabletBL -> TabletDAL: ListadoTablets(salaId)
TabletDAL -> DB: SELECT * FROM Tablet WHERE IdSala = @salaId
note right of DB
    SELECT IdTablet, IdSala,
           Nombre, Activa
    FROM Tablet
    WHERE IdSala = @salaId
    ORDER BY Nombre
end note
DB --> TabletDAL: Lista de tablets
TabletDAL --> TabletBL: List<TabletEntidad>
TabletBL --> Controller: List<TabletEntidad>
Controller --> Vista: JSON { tablets: [...] }

Vista -> Vista: Renderizar tabla de tablets
Vista --> Admin: Mostrar tablets de la sala

== Crear Nueva Tablet ==
Admin -> Vista: Clic en "Nueva Tablet"
Vista --> Admin: Mostrar formulario modal
note right of Vista
    Campos del formulario:
    - IdSala (prellenado)
    - Nombre de la tablet
    - Activa (checkbox, por defecto true)
end note

Admin -> Vista: Ingresar nombre y guardar
Vista -> Vista: Validar nombre no vacío

Vista -> Controller: CrearTablet(tablet)
note right of Vista
    tablet = {
        IdSala: salaId,
        Nombre: "Tablet 1",
        Activa: true
    }
end note

Controller -> TabletBL: CrearTablet(tablet)
TabletBL -> TabletDAL: CrearTablet(tablet)
TabletDAL -> DB: INSERT INTO Tablet
note right of DB
    INSERT INTO Tablet (
        IdSala, Nombre, Activa
    ) OUTPUT INSERTED.IdTablet
    VALUES (@idSala, @nombre, @activa)
end note
DB --> TabletDAL: IdTablet
TabletDAL --> TabletBL: bool success (IdTablet > 0)
TabletBL --> Controller: bool success
Controller --> Vista: { success: true, mensaje: "Tablet creada" }

Vista -> Vista: Actualizar tabla con nueva tablet
Vista --> Admin: Mostrar mensaje de éxito

== Editar Tablet ==
Admin -> Vista: Clic en "Editar" en una tablet
Vista --> Admin: Mostrar formulario con datos actuales
Admin -> Vista: Modificar nombre y/o estado
Vista -> Controller: EditarTablet(tablet)
note right of Vista
    tablet = {
        IdTablet: 5,
        Nombre: "Tablet Principal",
        Activa: true
    }
end note

Controller -> TabletBL: EditarTablet(nombre, activa, idTablet)
TabletBL -> TabletDAL: EditarTablet(nombre, activa, idTablet)
TabletDAL -> DB: UPDATE Tablet
note right of DB
    UPDATE Tablet SET
        Nombre = @nombre,
        Activa = @activa
    WHERE IdTablet = @idTablet
end note
DB --> TabletDAL: Filas afectadas
TabletDAL --> TabletBL: bool success (filas > 0)
TabletBL --> Controller: bool success
Controller --> Vista: { success: true, mensaje: "Tablet actualizada" }

Vista -> Vista: Actualizar fila en tabla
Vista --> Admin: Mostrar mensaje de éxito

== Activar/Desactivar Tablet ==
Admin -> Vista: Toggle switch en tablet
note right of Admin
    Al desactivar una tablet,
    esta no podrá ser usada
    para responder encuestas
end note

Vista -> Controller: EditarTablet({ IdTablet, Nombre, Activa: false })
Controller -> TabletBL: EditarTablet(nombre, false, idTablet)
TabletBL -> TabletDAL: EditarTablet(nombre, false, idTablet)
TabletDAL -> DB: UPDATE Tablet SET Activa = 0
DB --> TabletDAL: OK
TabletDAL --> TabletBL: success
TabletBL --> Controller: success
Controller --> Vista: { success: true }
Vista -> Vista: Actualizar estado visual (badge rojo/verde)
Vista --> Admin: Tablet actualizada

== Validación al Responder Encuesta ==
note over Vista, DB
    Cuando un cliente intenta responder una encuesta,
    el sistema valida que la tablet esté activa
end note

participant "Cliente (Tablet)" as ClienteTablet
ClienteTablet -> Controller: IniciarEncuesta(idTablet, idSala)
Controller -> TabletBL: ListadoTablets(idSala)
TabletBL -> TabletDAL: ListadoTablets(idSala)
TabletDAL -> DB: SELECT tablets de la sala
DB --> TabletDAL: Tablets
TabletDAL --> TabletBL: List<TabletEntidad>

Controller -> Controller: Buscar tablet por IdTablet
alt Tablet no encontrada o inactiva
    Controller --> ClienteTablet: { success: false, mensaje: "Tablet no disponible" }
    ClienteTablet --> Admin: Mostrar mensaje de error
else Tablet activa
    Controller --> ClienteTablet: { success: true, mensaje: "Puede continuar" }
    ClienteTablet -> ClienteTablet: Mostrar encuesta
end

== Ver Reporte por Tablet ==
Admin -> Vista: Ver reportes
Vista --> Admin: Mostrar filtros con opción "Por Tablet"
Admin -> Vista: Filtrar por tablet específica

note right of Admin
    Los reportes pueden filtrarse
    por tablet para ver rendimiento
    individual de cada dispositivo
end note

Vista -> Controller: DataNPS(fechas, salaId, idTablet)
Controller -> Controller: Agregar filtro IdTablet en queries
note right of Controller
    En las consultas SQL se agrega:
    AND re.IdTablet = @idTablet
end note

Controller --> Vista: Datos filtrados por tablet
Vista --> Admin: Mostrar estadísticas de esa tablet

@enduml
