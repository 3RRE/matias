@startuml Secuencia_04_Generar_Reporte_Atributos

title Secuencia: Generar Reporte de Indicadores Atributo

actor "Administrador" as Admin
participant "Vista Web" as Vista
participant "ConfigClienteSatisfaccionController" as Controller
participant "RespuestaBL" as RespuestaBL
participant "RespuestaDAL" as RespuestaDAL
database "BD" as DB

== Selección de Indicador ==
Admin -> Vista: Acceder a reportes de atributos
Vista --> Admin: Mostrar lista de indicadores disponibles
note right of Vista
    Los indicadores son preguntas
    con campo "Indicador" != NULL
    y diferentes de 'NPS' y 'CSAT'
    
    Ejemplos:
    - LIMPIEZA
    - ATENCION
    - SEGURIDAD
    - VARIEDAD_JUEGOS
    - etc.
end note

Admin -> Vista: Seleccionar indicador, fechas, sala

== Solicitud de Datos ==
Vista -> Controller: DataIndicador(fechaInicio, fechaFin, indicador, salaId)

== Normalización y Cálculo de Periodos ==
Controller -> Controller: Normalizar fechas
Controller -> Controller: Calcular periodo anterior

== Obtener Respuestas del Indicador (Actual) ==
Controller -> RespuestaBL: ObtenerListaIndicadorRespuestas(fechaInicio, fechaFin, indicador, salaId)
RespuestaBL -> RespuestaDAL: ObtenerListaIndicadorRespuestas(fechaInicio, fechaFin, indicador, salaId)
RespuestaDAL -> DB: SELECT respuestas del indicador
note right of DB
    SELECT re.IdSala, re.FechaRespuesta,
           re.IdTablet, t.Nombre AS NombreTablet,
           o.Valor, p.Indicador
    FROM RespuestaPregunta rp
    INNER JOIN Opcion o ON rp.IdOpcion = o.IdOpcion
    INNER JOIN Pregunta p ON rp.IdPregunta = p.IdPregunta
    INNER JOIN RespuestaEncuesta re ON rp.IdRespuestaEncuesta = re.IdRespuestaEncuesta
    WHERE p.Indicador = @indicador
      AND re.IdSala = @salaId
      AND CONVERT(date, re.FechaRespuesta) BETWEEN @fechaInicio AND @fechaFin
end note
DB --> RespuestaDAL: Lista de respuestas con valores
RespuestaDAL --> RespuestaBL: List<IndicadorRespuesta>

== Obtener Respuestas del Indicador (Anterior) ==
Controller -> RespuestaBL: ObtenerListaIndicadorRespuestas(fechaInicioAnt, fechaFinAnt, indicador, salaId)
RespuestaBL -> RespuestaDAL: ObtenerListaIndicadorRespuestas(...)
RespuestaDAL -> DB: SELECT respuestas periodo anterior
DB --> RespuestaDAL: Lista de respuestas anteriores
RespuestaDAL --> RespuestaBL: List<IndicadorRespuesta>

== Obtener Serie Diaria ==
Controller -> RespuestaBL: ObtenerIndicadorDiario(fechaInicio, fechaFin, indicador)
RespuestaBL -> RespuestaDAL: ObtenerIndicadorDiario(fechaInicio, fechaFin, indicador)
RespuestaDAL -> DB: SELECT agrupado por fecha
note right of DB
    Por cada día calcula:
    - Total respuestas
    - Cantidad por nivel (1-5)
    - Porcentajes por nivel
    - IndicadorValor = %Muy Satisfecho - %Muy Insatisfecho
    
    Este valor puede ser:
    - Positivo: más Muy Satisfecho
    - Negativo: más Muy Insatisfecho
    - Cero: equilibrio
end note
DB --> RespuestaDAL: Datos diarios con indicadores
RespuestaDAL --> RespuestaBL: List<IndicadorDiarioDTO>

== Construcción de Respuesta ==
Controller -> Controller: Construir payload
note right of Controller
    payload = {
        periodoActual: { fechaInicio, fechaFin },
        periodoAnterior: { fechaInicio, fechaFin },
        indicador: {
            indicadorActual,
            indicadorAnterior,
            indicadorDiario
        },
        indicadorDiario
    }
end note

Controller --> Vista: JSON con datos del indicador

== Procesamiento Frontend ==
Vista -> Vista: Calcular estadísticas periodo actual
note right of Vista
    Del array indicadorActual:
    - Contar respuestas por nivel
    - Calcular porcentajes
    - Calcular valor indicador
    - Identificar nivel predominante
end note

Vista -> Vista: Calcular estadísticas periodo anterior
Vista -> Vista: Calcular deltas y tendencias
note right of Vista
    Deltas a calcular:
    - Delta valor indicador
    - Delta % Muy Satisfecho
    - Delta % Muy Insatisfecho
    - Tendencia (INCREMENTO/DECREMENTO/IGUAL)
end note

== Visualización ==
Vista -> Vista: Renderizar dashboard del indicador
note right of Vista
    Componentes del dashboard:
    1. Título con nombre del indicador
    2. Tarjeta principal con valor del indicador
    3. Comparativa con periodo anterior
    4. Distribución por niveles (gráfico barras)
    5. Evolución diaria (gráfico línea)
    6. Tabla detallada por tablet
    7. Resumen estadístico
end note

Vista --> Admin: Mostrar dashboard del indicador

alt Ver comentarios de este indicador
    Admin -> Vista: Clic en "Ver Comentarios"
    Vista -> Controller: ListarEncuestadosConComentarios(salaId, fechaInicio, fechaFin)
    Controller -> RespuestaBL: ObtenerEncuestados(salaId, fechaInicio, fechaFin)
    RespuestaBL -> RespuestaDAL: ObtenerEncuestados(...)
    RespuestaDAL -> DB: SELECT encuestados con clasificación NPS
    DB --> RespuestaDAL: Lista de encuestados
    
    Controller -> RespuestaBL: ObtenerRespuestasAtributos(salaId, fechaInicio, fechaFin)
    RespuestaBL -> RespuestaDAL: ObtenerRespuestasAtributos(...)
    RespuestaDAL -> DB: SELECT respuestas con comentarios
    note right of DB
        Trae preguntas donde:
        - Indicador IS NULL o = ''
        - Tiene comentario
    end note
    DB --> RespuestaDAL: Respuestas con comentarios
    
    Controller -> Controller: Unir datos por IdRespuestaEncuesta
    Controller --> Vista: JSON con encuestados y sus comentarios
    Vista -> Vista: Filtrar por indicador seleccionado
    Vista --> Admin: Mostrar modal con comentarios
end

@enduml
