@startuml Secuencia_02_Generar_Reporte_NPS

title Secuencia: Generar Reporte NPS

actor "Administrador" as Admin
participant "Vista Web" as Vista
participant "ConfigClienteSatisfaccionController" as Controller
participant "RespuestaBL" as RespuestaBL
participant "RespuestaDAL" as RespuestaDAL
database "BD" as DB

== Selección de Parámetros ==
Admin -> Vista: Acceder a Reportes
Vista --> Admin: Mostrar formulario filtros
Admin -> Vista: Seleccionar fechaInicio, fechaFin, salaId
Vista -> Vista: Validar fechas

== Solicitud de Datos ==
Vista -> Controller: DataNPS(fechaInicio, fechaFin, salaId)
Controller -> Controller: Normalizar fechas
Controller -> Controller: Calcular periodo anterior

note right of Controller
    Periodo actual: fechaInicio - fechaFin
    Periodo anterior: mismo rango,
    desplazado N días atrás
end note

== Obtener Respuestas NPS ==
Controller -> RespuestaBL: ObtenerNPSRespuestas(fechaInicio, fechaFin, salaId)
RespuestaBL -> RespuestaDAL: ObtenerNPSRespuestas(fechaInicio, fechaFin, salaId)
RespuestaDAL -> DB: SELECT respuestas WHERE Indicador='NPS'
note right of DB
    SELECT re.IdSala, re.FechaRespuesta,
           re.IdTablet, t.Nombre,
           o.Valor
    FROM RespuestaPregunta rp
    JOIN Opcion o ON rp.IdOpcion = o.IdOpcion
    JOIN Pregunta p ON rp.IdPregunta = p.IdPregunta
    JOIN RespuestaEncuesta re ON rp.IdRespuestaEncuesta = re.IdRespuestaEncuesta
    WHERE p.Indicador = 'NPS'
end note
DB --> RespuestaDAL: Respuestas con Valor 1-5
RespuestaDAL --> RespuestaBL: List<NpsRespuestaDTO>

== Obtener Respuestas Periodo Anterior ==
Controller -> RespuestaBL: ObtenerNPSRespuestas(fechaInicioAnt, fechaFinAnt, salaId)
RespuestaBL -> RespuestaDAL: ObtenerNPSRespuestas(fechaInicioAnt, fechaFinAnt, salaId)
RespuestaDAL -> DB: SELECT respuestas WHERE Indicador='NPS' (periodo anterior)
DB --> RespuestaDAL: Respuestas anteriores
RespuestaDAL --> RespuestaBL: List<NpsRespuestaDTO>

== Obtener Serie Mensual ==
Controller -> RespuestaBL: ObtenerNPSMensual(fechaInicio, fechaFin)
RespuestaBL -> RespuestaDAL: ObtenerNPSMensual(fechaInicio, fechaFin)
RespuestaDAL -> DB: SELECT agrupado por mes
note right of DB
    Calcula NPS por cada mes:
    NPS = %Promotores - %Detractores
    
    Promotores: Valor = 5
    Pasivos: Valor = 3 o 4
    Detractores: Valor = 1 o 2
end note
DB --> RespuestaDAL: Datos mensuales
RespuestaDAL --> RespuestaBL: List<NpsMensualDTO>

== Obtener Cantidad Respuestas Únicas ==
Controller -> RespuestaBL: ObtenerCantidadRespuestasAtributos(salaId, fechaInicio, fechaFin, "NPS")
RespuestaBL -> RespuestaDAL: ObtenerCantidadRespuestasAtributos(...)
RespuestaDAL -> DB: SELECT COUNT(DISTINCT NroDocumento)
DB --> RespuestaDAL: Cantidad única
RespuestaDAL --> RespuestaBL: int totalEncuestados

== Construcción de Respuesta ==
Controller -> Controller: Calcular indicadores periodo actual
note right of Controller
    Del Frontend (JavaScript):
    - Clasificar por valor:
      * Detractores (1,2)
      * Pasivos (3,4)
      * Promotores (5)
    - Calcular porcentajes
    - Calcular NPS
end note

Controller -> Controller: Calcular indicadores periodo anterior
Controller -> Controller: Calcular deltas y tendencias

Controller --> Vista: JSON { npsActual, npsAnterior, npsMensual, respuestasUnicas }

== Visualización ==
Vista -> Vista: Procesar datos
Vista -> Vista: Renderizar gráficos
note right of Vista
    - Tarjetas con NPS y deltas
    - Gráfico de barras (Detractores/Pasivos/Promotores)
    - Gráfico lineal mensual
    - Tabla de respuestas por tablet
end note
Vista --> Admin: Mostrar dashboard NPS

alt Exportar a Excel
    Admin -> Vista: Clic en "Exportar"
    Vista -> Controller: ExportarEncuestasExcel(salaId, fechaInicio, fechaFin)
    Controller -> RespuestaBL: ObtenerRespuestasEncuestas(...)
    RespuestaBL -> RespuestaDAL: ObtenerRespuestasEncuestas(...)
    RespuestaDAL -> DB: SELECT todas las respuestas detalladas
    DB --> RespuestaDAL: Datos completos
    RespuestaDAL --> RespuestaBL: List<RespuestaPlanoDTO>
    Controller -> Controller: Generar archivo Excel
    Controller --> Vista: { bytes: base64, fileName }
    Vista -> Vista: Descargar archivo
    Vista --> Admin: Archivo descargado
end

@enduml
