@startuml Secuencia_01_Responder_Encuesta

title Secuencia: Cliente Responde Encuesta de Satisfacción

actor "Cliente" as Cliente
participant "Tablet" as Tablet
participant "ConfigClienteSatisfaccionController" as Controller
participant "CSConfiguracionBL" as ConfigBL
participant "CSConfiguracionDAL" as ConfigDAL
participant "RespuestaBL" as RespuestaBL
participant "RespuestaDAL" as RespuestaDAL
database "BD" as DB

== Validación de Cliente ==
Cliente -> Tablet: Ingresar número de documento
Tablet -> Controller: ValidarCliente(idSala, nroDocumento)
Controller -> ConfigBL: PuedeResponderEncuesta(idSala, nroDocumento)
ConfigBL -> ConfigDAL: PuedeResponderEncuesta(idSala, nroDocumento)
ConfigDAL -> DB: SELECT configuración recurrencia
DB --> ConfigDAL: Configuración
ConfigDAL -> DB: SELECT COUNT respuestas hoy/mes
DB --> ConfigDAL: Cantidad respuestas
ConfigDAL --> ConfigBL: bool puedeResponder
ConfigBL --> Controller: bool puedeResponder

alt Cliente puede responder
    Controller --> Tablet: { success: true, mensaje: "Puede responder" }
    
    == Obtener Preguntas ==
    Tablet -> Controller: ObtenerPreguntas(tipoEncuesta=1)
    Controller -> Controller: Obtener preguntas CSAT, NPS y Atributo
    note right
        1. Pregunta CSAT (obligatoria)
        2. Pregunta NPS (obligatoria)
        3. 2 Preguntas Atributo aleatorias
           (de las activas y en rango de fechas)
    end note
    Controller --> Tablet: { preguntas: [...], opciones: [...] }
    
    == Cliente Responde ==
    Cliente -> Tablet: Seleccionar respuestas
    Cliente -> Tablet: (Opcional) Agregar comentarios
    Tablet -> Tablet: Validar respuestas obligatorias
    
    == Guardar Respuestas ==
    Tablet -> Controller: GuardarRespuestas(respuestaEncuesta)
    Controller -> RespuestaBL: GuardarRespuestaEncuesta(respuestaEncuesta)
    RespuestaBL -> RespuestaDAL: GuardarRespuestaEncuesta(respuestaEncuesta)
    RespuestaDAL -> DB: INSERT INTO RespuestaEncuesta
    DB --> RespuestaDAL: IdRespuestaEncuesta
    RespuestaDAL --> RespuestaBL: IdRespuestaEncuesta
    
    loop Para cada pregunta respondida
        Controller -> RespuestaBL: GuardarRespuestaPregunta(respuestaPregunta)
        RespuestaBL -> RespuestaDAL: GuardarRespuestaPregunta(respuestaPregunta)
        RespuestaDAL -> DB: INSERT INTO RespuestaPregunta
        DB --> RespuestaDAL: IdRespuestaPregunta
        RespuestaDAL --> RespuestaBL: IdRespuestaPregunta
    end
    
    RespuestaBL --> Controller: success: true
    Controller --> Tablet: { success: true, mensaje: "Encuesta guardada" }
    Tablet -> Cliente: Mostrar mensaje de agradecimiento
    
else Cliente NO puede responder
    Controller --> Tablet: { success: false, mensaje: "Ya respondió hoy" }
    Tablet -> Cliente: Mostrar mensaje de restricción
end

@enduml
